<!-- Store Header -->
<div class="store-header" *ngIf="store">
  <div class="store-cover">
    <img [src]="getCoverImage(store)" 
         [alt]="store.storeName"
         (error)="handleImageError($event, 'store')">
  </div>
  <div class="store-info">
    <div class="store-avatar">
      <img [src]="getStoreImage(store)" 
           [alt]="store.storeName"
           (error)="handleImageError($event, 'store')">
    </div>
    <div class="store-details">
      <h1>{{store.storeName}}</h1>
      <p class="store-description">{{store.description}}</p>
      <div class="store-actions">
        <button mat-stroked-button (click)="followStore()">
          <mat-icon>favorite</mat-icon>
          Follow Store
        </button>
        <button mat-stroked-button (click)="contactSeller()">
          <mat-icon>message</mat-icon>
          Contact Seller
        </button>
        <button mat-stroked-button>
          Request a customization
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Store Navigation -->
<div class="store-navigation">
  <div class="nav-container">
    <!-- Left Navigation -->
    <div class="nav-buttons">
      <button mat-button [class.active]="activeTab === 'products'" (click)="setActiveTab(0)">
        Products
        <span class="count">{{store?.productCount || 0}}</span>
      </button>
      <button mat-button [class.active]="activeTab === 'reviews'" (click)="setActiveTab(1)">
        Reviews
        <span class="count">{{store?.feedbackCount || 0}}</span>
      </button>
      <button mat-button [class.active]="activeTab === 'analytics'" (click)="setActiveTab(2)">
        Feedback Analytics
      </button>
      <button mat-button [class.active]="activeTab === 'event'" (click)="setActiveTab(3)">
        Virtuel Event
      </button>
      <button mat-button [class.active]="activeTab === 'donation'" (click)="setActiveTab(4)">
        Donation Campaign
      </button>
    </div>

    <!-- Right Search -->
    <div class="search-bar" *ngIf="activeTab === 'products'">
      <mat-form-field appearance="outline">
        <mat-label>Search products</mat-label>
        <input matInput [value]="searchQuery" (input)="searchQuery = $any($event.target).value; searchProducts()" placeholder="Search by name...">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>
  </div>
</div>

<!-- Filter Section -->
<div class="filters-section" *ngIf="activeTab === 'products'">
  <mat-card>
    <mat-card-content>
      <div class="filters-container">
        <h2>{{store?.productCount || 0}} Products</h2>
        
        <div class="sort-dropdown">
          <mat-form-field appearance="outline">
            <mat-label>Sort By</mat-label>
            <mat-select [(ngModel)]="selectedSort">
              <mat-option *ngFor="let option of sortOptions" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<!-- Main Content Area -->
<div class="main-content">
  <div class="content-container">
    <!-- Store Content -->
    <div class="store-content" *ngIf="store">
      <div [ngSwitch]="activeTab">
        <!-- Products Tab -->
        <div *ngSwitchCase="'products'" class="products-grid">
          <mat-card class="product-card" *ngFor="let product of filteredProducts">
            <!-- Product Image -->
            <div class="product-image">
              <img [src]="getProductImageUrl(product)" 
                   [alt]="product.productName"
                   (error)="handleImageError($event, 'product')">
              
              <!-- Badges -->
              <div class="product-badges">
                <span class="bestseller-badge" *ngIf="product.isBestseller">
                  <mat-icon>star</mat-icon> Bestseller
                </span>
                <span class="discount-badge" *ngIf="product.hasDiscount">
                  -{{product.discountPercentage}}%
                </span>
              </div>

              <!-- Favorite Button -->
              <button mat-icon-button class="favorite-button" (click)="toggleFavorite(product)">
                <mat-icon color="warn" *ngIf="product.isFavorite">favorite</mat-icon>
                <mat-icon *ngIf="!product.isFavorite">favorite_border</mat-icon>
              </button>
            </div>

            <mat-card-content>
              <!-- Product Category -->
              <div class="product-category">{{ formatProductCategory(product.category) }}</div>

              <!-- Product Name -->
              <h3 class="product-name" [routerLink]="['/products', product.productId]">
                {{ product.productName }}
              </h3>

              <!-- Price -->
              <div class="product-price" [class.has-discount]="product.hasDiscount">
                <ng-container *ngIf="product.hasDiscount; else regularPrice">
                  <span class="current-price">{{calculateDiscountedPrice(product) | currency}}</span>
                  <span class="original-price">{{product.price | currency}}</span>
                </ng-container>
                <ng-template #regularPrice>
                  <span class="current-price">{{product.price | currency}}</span>
                </ng-template>
              </div>

              <!-- Stock Status -->
              <div class="product-stock" [class.out-of-stock]="product.stockQuantity === 0">
                {{ product.stockQuantity === 0 ? 'Out of Stock' : 
                   product.stockQuantity < 10 ? 'Low Stock' : 'In Stock' }}
              </div>

              <!-- Free Shipping Badge -->
              <div class="shipping-badge" *ngIf="product.freeShipping">
                <mat-icon>local_shipping</mat-icon>
                Free Shipping
              </div>
            </mat-card-content>

            <mat-card-actions>
              <button mat-stroked-button class="details-button" [routerLink]="['/products', product.productId]">
                <mat-icon>visibility</mat-icon>
                Details
              </button>
              <button mat-stroked-button class="cart-button"
                      (click)="addToCart(product)"
                      [disabled]="product.stockQuantity === 0">
                <mat-icon>shopping_cart</mat-icon>
                Add to Cart
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
        
        <!-- Reviews Tab -->
        <div *ngSwitchCase="'reviews'" class="reviews-section">
          <div class="reviews-header">
            <h2>Customer Reviews</h2>
            <div class="review-controls">
              <button mat-stroked-button (click)="toggleSummaries()">
                {{ showSummaries ? 'Show Full Reviews' : 'Show Summarized Reviews' }}
              </button>
              <button mat-stroked-button (click)="toggleSentimentDisplay()">
                {{ showMultilingualSentiment ? 'Show Basic Sentiment' : 'Show Detailed Sentiment' }}
              </button>
            </div>
          </div>
          
          <!-- Analyzed Feedback List -->
          <div class="analyzed-reviews" *ngIf="analyzedFeedbacks.length > 0">
            <mat-card class="review-card" *ngFor="let feedback of analyzedFeedbacks">
              <mat-card-header>
                <div mat-card-avatar class="reviewer-avatar">
                  <img *ngIf="feedback.userImage" [src]="feedback.userImage" alt="User avatar">
                  <mat-icon *ngIf="!feedback.userImage">account_circle</mat-icon>
                </div>
                <mat-card-title>{{ feedback.userName || 'Anonymous' }}</mat-card-title>
                <mat-card-subtitle>
                  <div class="rating">
                    <mat-icon *ngFor="let star of [1, 2, 3, 4, 5]" 
                              [class.filled]="star <= feedback.rating">star</mat-icon>
                  </div>
                  <span class="review-date">{{ feedback.createdAt | date }}</span>
                </mat-card-subtitle>
                
                <!-- Sentiment Badge - Toggle between basic and detailed -->
                <ng-container *ngIf="!showMultilingualSentiment">
                  <div class="sentiment-badge" *ngIf="feedback.sentimentScore !== undefined" 
                      [ngClass]="getSentimentClass(feedback.sentimentScore)" 
                      matTooltip="Sentiment Score: {{feedback.sentimentScore | number:'1.1-1'}}">
                    <mat-icon>{{ getSentimentIcon(feedback.sentimentScore) }}</mat-icon>
                    {{ feedback.sentimentScore >= 0.25 ? 'Positive' : 
                      feedback.sentimentScore <= -0.25 ? 'Negative' : 'Neutral' }}
                  </div>
                </ng-container>
                
                <!-- Detailed Multilingual Sentiment Badge -->
                <ng-container *ngIf="showMultilingualSentiment">
                  <div class="sentiment-badge" 
                      [ngClass]="getDetailedSentimentClass(feedback)" 
                      matTooltip="AI-detected sentiment {{ feedback.multilingualConfidence ? '(' + (feedback.multilingualConfidence | percent) + ')' : '' }}">
                    <mat-icon>{{ getDetailedSentimentIcon(feedback) }}</mat-icon>
                    {{ feedback.multilingualSentiment || (feedback.sentimentScore !== undefined ? (feedback.sentimentScore >= 0.25 ? 'Positive' : feedback.sentimentScore <= -0.25 ? 'Negative' : 'Neutral') : 'Neutral') }}
                    <span class="ai-badge" *ngIf="feedback.multilingualSentiment">AI</span>
                  </div>
                </ng-container>
              </mat-card-header>
              
              <mat-card-content>
                <!-- Show either summarized or full review based on toggle -->
                <p class="review-comment" *ngIf="!showSummaries || !feedback.summarizedComment">
                  {{ feedback.comment }}
                </p>
                <p class="review-summary" *ngIf="showSummaries && feedback.summarizedComment">
                  {{ feedback.summarizedComment }}
                  <span class="summary-badge" matTooltip="AI-generated summary">Summary</span>
                </p>
                
                <div class="feedback-metadata">
                  <mat-chip-set>
                    <mat-chip>{{ feedback.storeFeedbackType }}</mat-chip>
                    <mat-chip>
                      {{ feedback.wouldRecommend ? 'Recommends' : 'Does Not Recommend' }}
                    </mat-chip>
                  </mat-chip-set>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
          
          <div *ngIf="analyzedFeedbacks.length === 0 && !loadingFeedback" class="no-reviews">
            <p>No reviews yet. Be the first to leave a review!</p>
          </div>
          
          <div *ngIf="loadingFeedback" class="loading-reviews">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Loading reviews...</p>
          </div>
          
          <div *ngIf="error && !loadingFeedback" class="error-reviews">
            <mat-icon>error</mat-icon>
            <p>{{ error }}</p>
            <button mat-stroked-button (click)="store?.storeId && loadAnalyzedFeedback(store.storeId)">
              Try Again
            </button>
          </div>
          
          <!-- Create Feedback Form -->
          <div class="create-feedback-section">
            <app-store-feedback-create [storeId]="store?.storeId ?? 0"></app-store-feedback-create>
          </div>
        </div>
        
        <!-- Analytics Tab -->
        <div *ngSwitchCase="'analytics'" class="analytics-section">
          <h2>Feedback Analytics</h2>
          
          <div class="analytics-overview" *ngIf="feedbackAnalytics">
            <mat-card class="analytics-card">
              <mat-card-header>
                <mat-card-title>Overview</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="analytics-stats">
                  <div class="stat-item">
                    <div class="stat-value">{{ feedbackAnalytics.averageRating | number:'1.1-1' }}</div>
                    <div class="stat-label">Average Rating</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value">{{ feedbackAnalytics.totalFeedbacks }}</div>
                    <div class="stat-label">Total Reviews</div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
            
            <!-- Multilingual Sentiment Analysis Card -->
            <mat-card class="analytics-card" *ngIf="detailedSentimentChartData.length > 0">
              <mat-card-header>
                <mat-card-title>
                  <div class="card-title-with-badge">
                    Sentiment Analysis
                    <span class="ai-badge">AI</span>
                  </div>
                </mat-card-title>
                <mat-card-subtitle>AI-powered sentiment analysis in multiple languages</mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <div class="chart-container static-chart">
                  <div class="sentiment-bars">
                    <div *ngFor="let item of detailedSentimentChartData" class="sentiment-bar-item">
                      <div class="sentiment-label">{{ item.name }}</div>
                      <div class="sentiment-bar" 
                          [ngClass]="'sentiment-' + item.name.toLowerCase().replace(' ', '-')"
                          [style.width.%]="calculateDetailedSentimentBarWidth(item.value)">
                        <span class="sentiment-value">{{ item.value }}</span>
                      </div>
                      <div class="sentiment-percentage" *ngIf="multilingualSentimentAnalytics?.sentimentPercentages">
                        {{ getSentimentPercentage(item.name) }}
                      </div>
                    </div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
            
            <!-- Legacy Sentiment Distribution Chart -->
            <mat-card class="analytics-card" *ngIf="sentimentChartData.length > 0">
              <mat-card-header>
                <mat-card-title>Sentiment Distribution</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="chart-container static-chart">
                  <div class="sentiment-bars">
                    <div *ngFor="let item of sentimentChartData" class="sentiment-bar-item">
                      <div class="sentiment-label">{{ item.name }}</div>
                      <div class="sentiment-bar" 
                          [ngClass]="'sentiment-' + item.name.toLowerCase()"
                          [style.width.%]="item.value / (feedbackAnalytics.totalFeedbacks || 1) * 100">
                        <span class="sentiment-value">{{ item.value }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
          
          <div *ngIf="!feedbackAnalytics && !loadingFeedback" class="no-analytics">
            <p>No analytics available. Store needs more reviews to generate analytics.</p>
          </div>
          
          <div *ngIf="loadingFeedback" class="loading-analytics">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Loading analytics...</p>
          </div>
        </div>

        <div *ngSwitchCase="'event'" class="reviews-section">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <h2 style="margin: 0;">Virtual Event</h2>
            <button mat-raised-button *ngIf="role === 'SELLER'" color="primary" (click)="openCreateEventDialog()">
              Create a Virtual Event
            </button>
          </div>
          <app-event-store [events]="events"></app-event-store>
          </div>


          <div *ngSwitchCase="'donation'" class="analytics-section">
            <div style="display: flex; align-items: center; justify-content: space-between;">
            <h2>
              Donation Campaign
            </h2>
            <button mat-raised-button *ngIf="role === 'SELLER'" color="primary" (click)="openCreateDonationDialog()">
              Create a Donation Campaign
            </button>
          </div>
            <app-campaign-details [campaigns]="campaigns"></app-campaign-details>

            </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Spinner -->
<div class="loading-spinner" *ngIf="loading">
  <mat-spinner></mat-spinner>
</div>

<!-- Error Message -->
<div class="error-message" *ngIf="error">
  <p>{{error}}</p>
</div>
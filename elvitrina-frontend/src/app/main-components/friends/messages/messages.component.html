<div class="messages-container">
    <div class="friends-list">
      <h3>Chats</h3>
      <div class="search-box">
        <input type="text" [(ngModel)]="searchTerm" placeholder="Search friends...">
      </div>
      <div *ngFor="let friend of filteredFriends" 
           class="friend-item" 
           [ngClass]="{'selected': selectedFriend?.id === friend.id}"
           (click)="openChat(friend)">
        <div class="avatar-container">
          <img [src]="friend.image || 'assets/images/default-avatar.png'" 
               (error)="onImageError($event)" 
               alt="Profile picture">
            <div class="status-indicator" [ngClass]="friend.isOnline ? 'online' : 'offline'"></div>
        </div>
        <div class="friend-info">
          <div class="friend-name">
            {{ friend.firstname || 'Unknown' }} {{ friend.lastname || '' }}
          </div>
          <div class="last-message" *ngIf="friend.lastMessage">
            {{ (friend.lastMessage.length > 20) ? (friend.lastMessage | slice:0:20) + '...' : friend.lastMessage }}
          </div>
        </div>
        <div class="message-time" *ngIf="friend.lastMessageTime">
          {{ friend.lastMessageTime | date:'shortTime' }}
        </div>
      </div>
      <div *ngIf="friends.length === 0" class="no-friends">
        No friends found. Add friends to start chatting!
      </div>
    </div>
  
    <div class="chat-window" *ngIf="selectedFriend">
      <div class="chat-header">
        <div class="friend-profile">
          <img [src]="selectedFriend.image || 'assets/images/default-avatar.png'" 
               (error)="onImageError($event)" 
               alt="Profile picture">
          <div class="header-info">
            <div class="header-name">{{ selectedFriend.firstname }} {{ selectedFriend.lastname }}</div>
            <div class="header-status">{{ selectedFriend.isOnline ? 'Online' : 'Offline' }}</div>
          </div>
        </div>
        <div class="header-actions">
          <button class="action-btn"><i class="fa fa-phone"></i></button>
          <button class="action-btn"><i class="fa fa-video"></i></button>
          <button class="action-btn"><i class="fa fa-info-circle"></i></button>
        </div>
      </div>
  
      <div class="chat-messages" #messageContainer>
        <div class="date-separator" *ngIf="conversation.length > 0">
          {{ getMessageDate(conversation[0]) | date:'mediumDate' }}
        </div>
  
        <div *ngFor="let msg of conversation; let i = index">
          <!-- Date separator when day changes -->
          <div class="date-separator" *ngIf="i > 0 && showDateSeparator(conversation[i-1], msg)">
            {{ getMessageDate(msg) | date:'mediumDate' }}
          </div>
  
          <div class="message-wrapper" [ngClass]="{'from-me': msg.senderId === userId, 'from-them': msg.senderId !== userId}">
            <div class="message-content">
              {{ msg.content }}
              <div class="timestamp">
                {{ msg.sentAt | date:'shortTime' }}
                <span class="status-icon" *ngIf="msg.senderId === userId">
                  <i class="fa" [ngClass]="{'fa-check': msg.delivered, 'fa-check-double': msg.read}"></i>
                </span>
              </div>
            </div>
          </div>
        </div>
  
        <div *ngIf="isTyping" class="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>
  
      <div class="chat-input">
        <button class="input-action"><i class="fa fa-paperclip"></i></button>
        <input [(ngModel)]="messageContent" 
               placeholder="Type a message..." 
               (keyup.enter)="sendMessage()"
               (focus)="markAsRead()"
               (input)="onTyping(true)">
        <button class="emoji-btn"><i class="fa fa-smile"></i></button>
        <button class="send-btn" (click)="sendMessage()" [disabled]="!messageContent.trim()">
          <i class="fa fa-paper-plane"></i>
        </button>
      </div>
    </div>
  
    <div class="empty-state" *ngIf="!selectedFriend">
      <div class="empty-icon">
        <i class="fa fa-comments"></i>
      </div>
      <h3>Select a conversation</h3>
      <p>Choose a friend from the list to start chatting</p>
    </div>
  </div>
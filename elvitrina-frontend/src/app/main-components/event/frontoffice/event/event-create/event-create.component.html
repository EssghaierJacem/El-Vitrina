<div *ngIf="loading" class="loading-container">
  <mat-spinner diameter="50"></mat-spinner>
  <p>Loading event details...</p>
</div>

<div *ngIf="!loading" class="event-details-container">
  <!-- Event Creation Form -->
  <section class="event-overview">
    <mat-card class="overview-card">
      <mat-card-content>
        <h1 class="section-title">Create New Event</h1>
       
        <form [formGroup]="eventForm" (ngSubmit)="saveEvent()">
          <div class="form-fields">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Event Title</mat-label>
              <input matInput formControlName="title" placeholder="Enter event title">
              <mat-error *ngIf="eventForm.get('title')?.hasError('required')">
                Title is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Description</mat-label>
              <textarea matInput formControlName="description" placeholder="Enter event description" rows="4"></textarea>
              <mat-error *ngIf="eventForm.get('description')?.hasError('required')">
                Description is required
              </mat-error>
            </mat-form-field>

            <!-- Added Generate AI Image Button -->
            <button mat-raised-button color="accent" 
                    type="button" (click)="onGenerateAIImage()" class="image-button">
              <mat-icon>auto_awesome</mat-icon>
              <span>Update With AI</span>
            </button>

            <div class="two-column">
              <mat-form-field appearance="outline">
                <mat-label>Start Date & Time</mat-label>
                <input matInput [matDatepicker]="picker" formControlName="startDateTime">
                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
                <mat-error *ngIf="eventForm.get('startDateTime')?.hasError('required')">
                  Start date and time is required
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Ticket Price</mat-label>
                <input matInput type="number" formControlName="ticketPrice" placeholder="0.00">
                <span matPrefix>$ </span>
                <mat-error *ngIf="eventForm.get('ticketPrice')?.hasError('required')">
                  Ticket price is required
                </mat-error>
                <mat-error *ngIf="eventForm.get('ticketPrice')?.hasError('min')">
                  Price cannot be negative
                </mat-error>
              </mat-form-field>
            </div>

            <div class="two-column">
              <mat-form-field appearance="outline">
                <mat-label>Event Type</mat-label>
                <mat-select formControlName="eventType">
                  <mat-option *ngFor="let type of eventTypes" [value]="type">
                    {{type}}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Event Mode</mat-label>
                <mat-select formControlName="eventMode">
                  <mat-option *ngFor="let mode of eventModes" [value]="mode">
                    {{mode}}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>

            <mat-form-field appearance="outline">
              <mat-label>Maximum Participants</mat-label>
              <input matInput type="number" formControlName="maxParticipants" placeholder="10">
              <mat-error *ngIf="eventForm.get('maxParticipants')?.hasError('required')">
                Maximum participants is required
              </mat-error>
              <mat-error *ngIf="eventForm.get('maxParticipants')?.hasError('min')">
                Must have at least 1 participant
              </mat-error>
            </mat-form-field>
          </div>
         
          <div class="image-actions">
            <div *ngIf="selectedImageUrl">
              <h3>Selected Image Preview:</h3>
              <img [src]="selectedImageUrl" alt="Selected Image" style="max-width: 200px; max-height: 200px;" />
            </div>
            <button mat-raised-button color="accent" 
                type="button" (click)="onUploadImage()" class="image-button">
              <mat-icon>upload</mat-icon>
              <span>Upload Image</span>
            </button>
            <button mat-raised-button color="accent" 
                type="button" (click)="onGenerateAIImage()" class="image-button">
              <mat-icon>auto_awesome</mat-icon>
              <span>Generate AI Image</span>
            </button>
            <input type="file" #fileInput style="display: none" 
                accept="image/*" (change)="onFileSelected($event)">
          </div>

          <div class="form-actions">
            <button mat-raised-button color="primary" type="submit" 
                [disabled]="eventForm.invalid || saving" class="save-button">
              <mat-icon>save</mat-icon>
              <span>{{ saving ? 'Saving...' : 'Save Event' }}</span>
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </section>
  
  <!-- Calendar -->
  <section class="calendar-section">
    <h2 class="section-title">
      Event Calendar
      <span class="calendar-subtitle">Click on a date to add a session</span>
    </h2>
    <mat-card class="calendar-card">
      <mat-card-content>
        <div *ngIf="role === 'SELLER' && !googleEventsLoaded" class="loading-calendar">
          <mat-spinner diameter="30"></mat-spinner>
          <span>Loading Google Calendar events...</span>
        </div>
        <app-calendar 
          [calendarEvents]="displayedCalendarEvents" 
          [role]="role" 
          (sessionCreated)="onSessionCreated($event)">
        </app-calendar>
      </mat-card-content>
    </mat-card>
  </section>
</div>